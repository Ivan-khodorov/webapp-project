<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>ĞšĞ°Ñ€Ñ‚Ğ° Ğ·Ğ¾Ğ½</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    .controls {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 999;
      display: flex;
      gap: 10px;
      background: white;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
  <div class="controls" id="adminControls" style="display: none;">
    <label><input type="date" id="dateStart" /></label>
    <label><input type="date" id="dateEnd" /></label>
    <button onclick="sendZone()">Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ñ‚ÑŒ Ğ·Ğ¾Ğ½Ñƒ</button>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
  <script>
    Telegram.WebApp.ready();

    let city = "ĞœĞ¾ÑĞºĞ²Ğ°";
    let mode = "worker";
    let telegramId = 0;
    let drawnItems;
    let map;
    let socket;
    let markers = [];

    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has("startapp")) {
      const [modeParam, cityParam] = urlParams.get("startapp").split("-");
      city = decodeURIComponent(cityParam || "ĞœĞ¾ÑĞºĞ²Ğ°"); // â† Ğ´ĞµĞºĞ¾Ğ´Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾
      mode = modeParam || "worker";
      console.log("ğŸ™ Ğ“Ğ¾Ñ€Ğ¾Ğ´ Ğ¸Ğ· startapp:", city);
    } else {
      alert("Ğ“Ğ¾Ñ€Ğ¾Ğ´ Ğ½Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½. Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ WebApp Ñ‡ĞµÑ€ĞµĞ· Telegram-Ğ±Ğ¾Ñ‚Ğ°.");
      throw new Error("ĞĞµ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ğ½ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€ startapp");
    }
    function setupMap() {
      const isAdmin = mode === "admin";
      if (isAdmin) {
        document.getElementById("adminControls").style.display = "flex";
      }

      map = L.map("map").setView([55.75, 37.61], 13);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors"
      }).addTo(map);

      drawnItems = new L.FeatureGroup();
      map.addLayer(drawnItems);

      if (isAdmin) {
        const drawControl = new L.Control.Draw({
          draw: {
            polyline: false,
            rectangle: false,
            circle: false,
            marker: false,
            circlemarker: false
          },
          edit: { featureGroup: drawnItems }
        });
        map.addControl(drawControl);

        map.on(L.Draw.Event.CREATED, function (event) {
          drawnItems.clearLayers();
          drawnItems.addLayer(event.layer);
        });
      }

      centerOnCity();
      connectWebSocket();
      loadExistingZones();
      loadExistingPoints();
    }

    function centerOnCity() {
      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${city}`)
        .then(res => res.json())
        .then(data => {
          if (data.length > 0) {
            map.setView([parseFloat(data[0].lat), parseFloat(data[0].lon)], 13);
          }
        });
    }

    function connectWebSocket() {
      const wsUrl = `wss://humorous-tranquility-nixpackspythonversion311.up.railway.app/ws/${city}`;
      socket = new WebSocket(wsUrl);

      socket.onopen = () => console.log("ğŸŒ WebSocket Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ñ‘Ğ½:", wsUrl);

      socket.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        console.log("ğŸ“¥ WS ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ:", msg);

        if (msg.type === "new_zone") {
          const coords = msg.data.polygon.map(p => [p.lat, p.lon]);
          const poly = L.polygon(coords, { color: "red" }).addTo(map);
          poly.bindTooltip(`Ğ—Ğ¾Ğ½Ğ° â„–${msg.data.zone_number}<br>ğŸ—“ ${msg.data.date_start} â€“ ${msg.data.date_end}`);
        }

        if (msg.type === "new_point") {
          const p = msg.data;
          const marker = L.circleMarker([p.lat, p.lon], {
            radius: 8,
            color: "blue"
          }).addTo(map);
          const html = `
            <b>ğŸ“¬ Ğ›Ğ¸ÑÑ‚Ğ¾Ğ²Ğ¾Ğº:</b> ${p.flyer_count}<br>
            <b>ğŸ‘¤:</b> ${p.username || "?"}<br>
            <b>ğŸ•’:</b> ${p.created_at || ""}<br>
            ${p.order ? `<b>#ï¸âƒ£:</b> ${p.order}` : ""}
          `;
          marker.bindPopup(html);
          markers.push(marker);
        }
      };

      socket.onclose = () => {
        console.warn("ğŸ”Œ WebSocket Ğ¾Ñ‚ĞºĞ»ÑÑ‡Ñ‘Ğ½. ĞŸĞµÑ€ĞµĞ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼...");
        setTimeout(connectWebSocket, 3000);
      };
    }

    function loadExistingZones() {
      fetch(`https://humorous-tranquility-nixpackspythonversion311.up.railway.app/zones/${city}`)
        .then(res => res.json())
        .then(json => {
          if (json.status === "ok" && Array.isArray(json.zones)) {
            for (const zone of json.zones) {
              const coords = zone.polygon.map(p => [p.lat, p.lon]);
              const poly = L.polygon(coords, { color: "red" }).addTo(map);
              if (zone.zone_number && zone.date_start && zone.date_end) {
                poly.bindTooltip(`Ğ—Ğ¾Ğ½Ğ° â„–${zone.zone_number}<br>ğŸ—“ ${zone.date_start} â€“ ${zone.date_end}`);
              }
            }
          }
        });
    }

    function loadExistingPoints() {
      fetch(`https://humorous-tranquility-nixpackspythonversion311.up.railway.app/points/${city}`)
        .then(res => res.json())
        .then(json => {
          if (json.points) {
            for (const p of json.points) {
              const marker = L.circleMarker([p.lat, p.lon], {
                radius: 8,
                color: "blue"
              }).addTo(map);
              const html = `
                <b>ğŸ“¬ Ğ›Ğ¸ÑÑ‚Ğ¾Ğ²Ğ¾Ğº:</b> ${p.flyer_count}<br>
                <b>ğŸ‘¤ Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ½Ğ¸Ğº:</b> ${p.username}<br>
                <b>ğŸ•’ Ğ’Ñ€ĞµĞ¼Ñ:</b> ${p.created_at}<br>
                <b>#ï¸âƒ£ Ğ¢Ğ¾Ñ‡ĞºĞ° â„–:</b> ${p.order}
              `;
              marker.bindPopup(html);
              markers.push(marker);
            }
          }
        });
    }

    window.sendZone = function () {
      const features = drawnItems?.toGeoJSON?.();
      if (!features || !features.features.length) {
        alert("âš ï¸ ĞĞ°Ñ€Ğ¸ÑÑƒĞ¹Ñ‚Ğµ Ğ·Ğ¾Ğ½Ñƒ.");
        return;
      }

      const start = document.getElementById("dateStart").value;
      const end = document.getElementById("dateEnd").value;
      if (!start || !end) {
        alert("â± Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ğ´Ğ°Ñ‚Ñ‹ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ Ğ·Ğ¾Ğ½Ñ‹.");
        return;
      }

      const polygon = features.features[0].geometry.coordinates[0]
        .map(([lon, lat]) => ({ lat, lon }));

      const payload = {
        city,
        polygon,
        date_start: start,
        date_end: end,
        telegram_id: telegramId
      };

      fetch("https://humorous-tranquility-nixpackspythonversion311.up.railway.app/save-zone", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
      .then(res => res.json())
      .then(result => {
        alert("âœ… Ğ—Ğ¾Ğ½Ğ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ°: #" + result.zone_number);
        Telegram.WebApp.close();
      })
      .catch(err => {
        alert("âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: " + err.message);
      });
    };
  </script>
</body>
</html>